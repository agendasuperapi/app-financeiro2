name: Complete Supabase Deployment for Redistribution

on:
  push:
    branches: [ main, developer ]
    paths: 
      - 'supabase/**'
      - 'src/**'
      - 'package.json'
      - 'capacitor.config.ts'
      - 'vite.config.ts'
  workflow_dispatch:
    inputs:
      setup_mode:
        description: 'Setup mode: fresh (new install) or update (existing)'
        default: 'update'
        required: false
        type: choice
        options:
          - fresh
          - update
      force_all_migrations:
        description: 'Force apply all migrations (including pre-installation)'
        default: false
        required: false
        type: boolean
      build_apk:
        description: 'Build and upload APK to Hostinger'
        default: true
        required: false
        type: boolean

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¦ Checkout Repository
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Supabase CLI
      uses: supabase/setup-cli@v1
      with:
        version: latest

    - name: ðŸš€ Deploy Complete Supabase Setup
      env:
        SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        SETUP_MODE: ${{ inputs.setup_mode || 'update' }}
        FORCE_ALL_MIGRATIONS: ${{ inputs.force_all_migrations || 'false' }}
      run: |
        echo "ðŸ”‘ Logging into Supabase..."
        supabase login --token $SUPABASE_ACCESS_TOKEN
        
        echo "ðŸ”— Linking to project..."
        supabase link --project-ref $SUPABASE_PROJECT_ID
        
        echo "ðŸ“Š Current setup mode: $SETUP_MODE"
        echo "ðŸ”„ Force all migrations: $FORCE_ALL_MIGRATIONS"
        
        # Check for pending pre-installation migrations
        echo "ðŸ” Checking for pre-installation migrations..."
        PRE_INSTALL_MIGRATIONS=$(find supabase/migrations -name "20250609195700_*.sql" | wc -l)
        
        if [ "$PRE_INSTALL_MIGRATIONS" -gt 0 ]; then
          echo "ðŸ“‹ Found pre-installation migrations that need to be applied"
          echo "ðŸ”§ These migrations contain admin setup and initial configuration"
        fi
        
        if [ "$SETUP_MODE" = "fresh" ]; then
          echo "ðŸ†• Fresh installation detected - applying all migrations..."
          
          # Reset and apply all migrations
          supabase db reset --linked
          
          echo "âœ… Database reset and migrations applied"
        else
          echo "ðŸ”„ Update mode - checking for migrations to apply..."
          
          # List current migration status
          echo "ðŸ“Š Current migration status:"
          supabase migration list --linked
          
          # Check if we need to force all migrations or use include-all
          if [ "$FORCE_ALL_MIGRATIONS" = "true" ] || [ "$PRE_INSTALL_MIGRATIONS" -gt 0 ]; then
            echo "ðŸ”§ Using --include-all flag to apply pre-installation migrations..."
            echo "âš ï¸  This will apply migrations with timestamps before existing remote migrations"
            
            # Apply all migrations including those with earlier timestamps
            supabase db push --linked --include-all
            
            echo "âœ… All migrations synchronized (including pre-installation)"
          else
            echo "ðŸ”„ Applying new migrations only..."
            
            # Normal migration push
            supabase db push --linked
            
            echo "âœ… New migrations synchronized"
          fi
        fi
        
        # Final migration status check
        echo "ðŸ“‹ Final migration status:"
        supabase migration list --linked
        
        echo "ðŸŽ¯ Deploying Edge Functions..."
        
        # Deploy all functions
        supabase functions deploy create-admin-user --project-ref $SUPABASE_PROJECT_ID
        supabase functions deploy get-admin-settings --project-ref $SUPABASE_PROJECT_ID
        supabase functions deploy update-admin-settings --project-ref $SUPABASE_PROJECT_ID
        supabase functions deploy migrate-settings --project-ref $SUPABASE_PROJECT_ID
        supabase functions deploy get-public-settings --project-ref $SUPABASE_PROJECT_ID
        supabase functions deploy get-stripe-prices --project-ref $SUPABASE_PROJECT_ID
        supabase functions deploy get-plan-config --project-ref $SUPABASE_PROJECT_ID
        supabase functions deploy check-subscription-status --project-ref $SUPABASE_PROJECT_ID
        supabase functions deploy verify-admin-access --project-ref $SUPABASE_PROJECT_ID
        supabase functions deploy promote-to-admin --project-ref $SUPABASE_PROJECT_ID
        supabase functions deploy grant-admin-access --project-ref $SUPABASE_PROJECT_ID
        supabase functions deploy recover-purchases --project-ref $SUPABASE_PROJECT_ID
        supabase functions deploy customer-portal --project-ref $SUPABASE_PROJECT_ID
        supabase functions deploy create-checkout-session --project-ref $SUPABASE_PROJECT_ID
        supabase functions deploy stripe-webhook --project-ref $SUPABASE_PROJECT_ID
        supabase functions deploy sync-subscriptions --project-ref $SUPABASE_PROJECT_ID
        supabase functions deploy update-plan-config --project-ref $SUPABASE_PROJECT_ID
        supabase functions deploy update-admin-email --project-ref $SUPABASE_PROJECT_ID
        supabase functions deploy update-user-email --project-ref $SUPABASE_PROJECT_ID
        supabase functions deploy generate-html --project-ref $SUPABASE_PROJECT_ID
        supabase functions deploy generate-pwa-manifest --project-ref $SUPABASE_PROJECT_ID
        
        echo "âœ… All Edge Functions deployed"

    - name: ðŸ”§ Configure Public Functions
      env:
        SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
      run: |
        echo "âš™ï¸ Configuring public functions..."
        
        # Configure stripe-webhook function
        curl -X PATCH \
          "https://api.supabase.com/v1/projects/$SUPABASE_PROJECT_ID/functions/stripe-webhook" \
          -H "Authorization: Bearer $SUPABASE_ACCESS_TOKEN" \
          -H "Content-Type: application/json" \
          -d '{
            "verify_jwt": false,
            "import_map": true
          }' || echo "âš ï¸  Webhook configuration may need manual setup"
        
        # Configure generate-html function to be public (no JWT required)
        curl -X PATCH \
          "https://api.supabase.com/v1/projects/$SUPABASE_PROJECT_ID/functions/generate-html" \
          -H "Authorization: Bearer $SUPABASE_ACCESS_TOKEN" \
          -H "Content-Type: application/json" \
          -d '{
            "verify_jwt": false,
            "import_map": true
          }' || echo "âš ï¸  generate-html configuration may need manual setup"
        
        echo "âœ… Public functions configured"

    - name: ðŸ—„ï¸ Verify Storage Setup
      env:
        SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
      run: |
        echo "ðŸ“ Checking storage buckets..."
        
        # Check if uploads bucket exists
        BUCKET_CHECK=$(curl -s \
          "https://api.supabase.com/v1/projects/$SUPABASE_PROJECT_ID/storage/buckets" \
          -H "Authorization: Bearer $SUPABASE_ACCESS_TOKEN" | grep -o '"name":"uploads"' || echo "not_found")
        
        if [ "$BUCKET_CHECK" = "not_found" ]; then
          echo "âš ï¸  Storage bucket 'uploads' not found - manual setup may be required"
        else
          echo "âœ… Storage bucket 'uploads' exists"
        fi

    - name: ðŸ‘¤ Setup/Verify Admin User
      env:
        SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      run: |
        echo "ðŸ‘¤ Creating initial admin user via Edge Function..."
        
        # Call Edge Function to create admin user
        response=$(curl -s -w "%{http_code}" -X POST \
          "https://$SUPABASE_PROJECT_ID.supabase.co/functions/v1/create-admin-user" \
          -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
          -H "Content-Type: application/json")
        
        http_code=$(echo "$response" | tail -c 4)
        body=$(echo "$response" | sed '$ s/...$//')
        
        echo "Response: $body"
        echo "HTTP Code: $http_code"
        
        if [ "$http_code" = "200" ]; then
          echo "âœ… Admin user created/verified successfully"
        else
          echo "âŒ Admin user creation failed with HTTP $http_code"
          echo "Response body: $body"
        fi
        
        echo "ðŸ” Verifying installation via SQL function..."
        
        # Verify installation using SQL function
        verification=$(curl -s -X POST \
          "https://$SUPABASE_PROJECT_ID.supabase.co/rest/v1/rpc/verify_installation" \
          -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
          -H "Content-Type: application/json" \
          -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
          -d '{}' || echo "[]")
        
        echo "Installation verification: $verification"
        
        echo "âœ… Admin user setup/verification completed"
        echo "ðŸ‘¤ Default admin: admin@admin.com / admin123!"
        echo "âš ï¸  CHANGE THE DEFAULT PASSWORD ON FIRST LOGIN!"

    - name: ðŸ”„ Run Settings Migration (Update Mode Only)
      if: ${{ inputs.setup_mode != 'fresh' }}
      env:
        SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      run: |
        echo "ðŸ”„ Running settings migration for existing installation..."
        
        # Call migrate-settings function
        curl -X POST \
          "https://$SUPABASE_PROJECT_ID.supabase.co/functions/v1/migrate-settings" \
          -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
          -H "Content-Type: application/json" \
          -d '{}' || echo "âš ï¸  Settings migration may need manual execution"
        
        echo "âœ… Settings migration completed"

    - name: âœ… Deployment Summary
      run: |
        echo "ðŸŽ‰ Deployment completed successfully!"
        echo ""
        echo "ðŸ“‹ Summary:"
        echo "- âœ… Database migrations applied"
        echo "- âœ… Edge Functions deployed"
        echo "- âœ… Storage verified"
        echo "- âœ… Webhook configured"
        echo "- âœ… Admin user verified/created"
        echo "- ðŸ‘¤ Admin login: admin@admin.com / admin123!"
        echo "- âš ï¸  CHANGE DEFAULT PASSWORD!"
        if [ "${{ inputs.setup_mode }}" != "fresh" ]; then
          echo "- âœ… Settings migration executed"
        fi
        echo ""
        echo "ðŸ”— Project URL: https://${{ secrets.SUPABASE_PROJECT_ID }}.supabase.co"
        echo "ðŸ“š Admin Panel: https://${{ secrets.SUPABASE_PROJECT_ID }}.supabase.co (login with admin@admin.com)"
        echo "ðŸ“– Installation Guide: See INSTALACAO_ADMIN.md"
        echo "ðŸ”§ Next steps: Login as admin and configure your secrets"

    - name: ðŸš¨ Deployment Failed
      if: failure()
      run: |
        echo "âŒ Deployment failed!"
        echo ""
        echo "ðŸ” Troubleshooting checklist:"
        echo "1. Verify all required secrets are configured:"
        echo "   - SUPABASE_ACCESS_TOKEN"
        echo "   - SUPABASE_PROJECT_ID" 
        echo "   - SUPABASE_SERVICE_ROLE_KEY"
        echo "   - SUPABASE_DB_PASSWORD"
        echo "2. Check Supabase project is active"
        echo "3. Verify permissions for the access token"
        echo "4. Check the Actions logs for specific error messages"

  build-and-deploy:
    runs-on: ubuntu-latest
    needs: deploy
    if: ${{ github.event_name == 'push' || inputs.build_apk != 'false' }}
    
    steps:
    - name: ðŸ“¦ Checkout Repository
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'

    - name: ðŸ“¥ Install Dependencies
      run: npm ci

    - name: ðŸ—ï¸ Build Project
      run: npm run build

    - name: ðŸŒ Upload Web Build to Hostinger
      env:
        HOSTINGER_FTP_HOST: ${{ secrets.HOSTINGER_FTP_HOST }}
        HOSTINGER_FTP_USER: ${{ secrets.HOSTINGER_FTP_USER }}
        HOSTINGER_FTP_PASSWORD: ${{ secrets.HOSTINGER_FTP_PASSWORD }}
        HOSTINGER_FTP_DIR: ${{ secrets.HOSTINGER_FTP_DIR || '/public_html' }}
      continue-on-error: true
      run: |
        if [ -z "$HOSTINGER_FTP_HOST" ] || [ -z "$HOSTINGER_FTP_USER" ] || [ -z "$HOSTINGER_FTP_PASSWORD" ]; then
          echo "âš ï¸  Hostinger FTP secrets not configured. Skipping web upload."
          echo "ðŸ’¡ To enable upload, configure HOSTINGER_FTP_HOST, HOSTINGER_FTP_USER, and HOSTINGER_FTP_PASSWORD secrets"
          exit 0
        fi
        
        echo "ðŸŒ Uploading web build to Hostinger..."
        
        # Install lftp for FTP upload
        sudo apt-get update
        sudo apt-get install -y lftp
        
        # Create FTP script to upload all files from dist folder
        cat > /tmp/ftp_upload_web.txt << EOF
        set ftp:ssl-allow no
        set ftp:passive-mode yes
        open -u $HOSTINGER_FTP_USER,$HOSTINGER_FTP_PASSWORD $HOSTINGER_FTP_HOST
        cd $HOSTINGER_FTP_DIR
        mirror -R -e dist/ ./
        bye
        EOF
        
        # Upload web build
        if lftp -f /tmp/ftp_upload_web.txt; then
          echo "âœ… Web build uploaded to Hostinger successfully!"
          echo "ðŸŒ Web app available at: https://$HOSTINGER_FTP_HOST"
        else
          echo "âš ï¸  FTP upload failed for web build"
        fi

    - name: ðŸ¤– Setup Java JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: ðŸ“± Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: ðŸ”§ Add Android Platform
      run: |
        if [ ! -d "android" ]; then
          echo "ðŸ“± Adding Android platform..."
          npx cap add android --yes
        else
          echo "âœ… Android platform already exists"
        fi

    - name: ðŸ”„ Sync Capacitor
      run: npx cap sync android

    - name: ðŸ”¨ Build Debug APK
      working-directory: ./android
      run: |
        echo "ðŸ”¨ Building debug APK for testing..."
        chmod +x ./gradlew
        ./gradlew assembleDebug
        
        echo "ðŸ“¦ Debug APK build completed!"
        echo "ðŸ“ APK location: app/build/outputs/apk/debug/app-debug.apk"
        ls -lh app/build/outputs/apk/debug/

    - name: ðŸ“¤ Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: app-debug-apk
        path: android/app/build/outputs/apk/debug/app-debug.apk
        retention-days: 30

    - name: ðŸŒ Upload to Hostinger via FTP
      env:
        HOSTINGER_FTP_HOST: ${{ secrets.HOSTINGER_FTP_HOST }}
        HOSTINGER_FTP_USER: ${{ secrets.HOSTINGER_FTP_USER }}
        HOSTINGER_FTP_PASSWORD: ${{ secrets.HOSTINGER_FTP_PASSWORD }}
        HOSTINGER_FTP_DIR: ${{ secrets.HOSTINGER_FTP_DIR || '/public_html' }}
      continue-on-error: true
      run: |
        if [ -z "$HOSTINGER_FTP_HOST" ] || [ -z "$HOSTINGER_FTP_USER" ] || [ -z "$HOSTINGER_FTP_PASSWORD" ]; then
          echo "âš ï¸  Hostinger FTP secrets not configured. Skipping upload."
          echo "ðŸ’¡ To enable upload, configure HOSTINGER_FTP_HOST, HOSTINGER_FTP_USER, and HOSTINGER_FTP_PASSWORD secrets"
          exit 0
        fi
        
        echo "ðŸŒ Uploading debug APK to Hostinger..."
        
        # Install lftp for FTP upload
        sudo apt-get update
        sudo apt-get install -y lftp
        
        # Create FTP script
        cat > /tmp/ftp_upload.txt << EOF
        set ftp:ssl-allow no
        set ftp:passive-mode yes
        open -u $HOSTINGER_FTP_USER,$HOSTINGER_FTP_PASSWORD $HOSTINGER_FTP_HOST
        cd $HOSTINGER_FTP_DIR
        put android/app/build/outputs/apk/debug/app-debug.apk -o app-debug.apk
        put android/app/build/outputs/apk/debug/app-debug.apk -o app-debug-$(date +%Y%m%d-%H%M%S).apk
        bye
        EOF
        
        # Upload APK
        if lftp -f /tmp/ftp_upload.txt; then
          echo "âœ… Debug APK uploaded to Hostinger successfully!"
          echo "ðŸ“± APK disponÃ­vel em: https://$HOSTINGER_FTP_HOST/app-debug.apk"
        else
          echo "âš ï¸  FTP upload falhou, mas APK estÃ¡ disponÃ­vel como artifact do GitHub"
        fi

    - name: âœ… Build Summary
      run: |
        echo "ðŸŽ‰ Build e Deploy concluÃ­dos com sucesso!"
        echo ""
        echo "ðŸ“‹ Resumo:"
        echo "- âœ… Projeto compilado"
        echo "- âœ… Build web gerado"
        echo "- âœ… Plataforma Android configurada"
        echo "- âœ… APK debug gerado (para testes)"
        echo ""
        
        if [ -n "${{ secrets.HOSTINGER_FTP_HOST }}" ]; then
          echo "ðŸ“¤ Upload Hostinger:"
          echo "- âœ… Build web enviado"
          echo "- âœ… APK enviado"
          echo ""
          echo "ðŸŒ App Web:"
          echo "  https://${{ secrets.HOSTINGER_FTP_HOST }}"
          echo ""
          echo "ðŸ“± APK para Testes:"
          echo "  https://${{ secrets.HOSTINGER_FTP_HOST }}/app-debug.apk"
          echo ""
          echo "ðŸ“ HistÃ³rico de APKs:"
          echo "  https://${{ secrets.HOSTINGER_FTP_HOST }}/app-debug-*.apk"
        else
          echo "- âš ï¸  Upload Hostinger nÃ£o configurado"
          echo ""
          echo "ðŸ’¡ Para habilitar upload automÃ¡tico, configure:"
          echo "   - HOSTINGER_FTP_HOST"
          echo "   - HOSTINGER_FTP_USER"
          echo "   - HOSTINGER_FTP_PASSWORD"
        fi
        echo ""
        echo "ðŸ’¾ Download alternativo:"
        echo "  APK disponÃ­vel como artifact do GitHub (30 dias)"